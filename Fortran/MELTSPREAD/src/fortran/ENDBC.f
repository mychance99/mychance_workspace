C...................................................................... 
C.....SUBROUTINE ENDBC CHECKS THERMAL CONDITIONS FOR CRUSTING, ABLATION, 
C.....AND SIMULTANEOUS CRUSTING AND ABLATION CASES TO DETERMINE WHETHER 
C.....THESE PROCESSES CAN BE SUSTAINED.  IF NOT, THE PROPER BOUNDARY 
C.....CONDITION IS SET.
C...................................................................... 
      SUBROUTINE ENDBC
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      DIMENSION HSEND(28)
      COMMON/CATCHR/A(999),B(999),C(999),D(999),P(999),Q(999),
     1RECON(999),DELVEL(999),DSRDT(999),DELHTS(999),EMAX(999,999),
     2DBLKEN(999),DELHIT(16,999),SOURCE(16,999),SRCTOT(999),
     3HCROLD(16,999),DCDOT(999),HCRUST(16,999),DFILM(16,999),
     4DFMOLD(16,999),DENOLD(999),SIGOX(999),SIGCON(999),BET(999),
     5TFZX(999),TFZC(999),TKX(999),TKM(999),THETO(999,999),
     6THET1(999,999),OMEG0(4,999),OMEG1(4,999),TAO0(999),TAO1(999),
     7SIG0(999),SIG1(999),TARGB(999),DADOT(999),DADOTG(999),
     8XLOLD(4,999),VISREX(999),TATMS(999),HTMP(999),DHTMP(999),
     9HTMOLD(999)
      COMMON/CATCHI/NUMS(4,999),NUMOLD(4,999),NTRACK(16),NSUMP(999),
     1NPASSG(999),NCRSTM(999),NCRRT(999),NPASS(999),NBURN,NBURNO     
      COMMON/PRINTB/ELEVAT(999),ELOLD(999),XDIST(999,999),XBTW(999,999),
     1TEMP(999,999),ENTHP(999,999),EOLD(999,999),ENBLK(999),EBKOLD(999),
     2TBULK(999),HITE(16,999),HITOLD(16,999),HTOT(999),HTOLD(999),
     3HTCFT(999),HTCOEF(999),QFLUXT(999),QFLUXB(999),VEL(999),ELO(999),
     4VELOLD(999),SRSCOR(16),AREA(999),RAD(999),ARC(999),VOLCN(16),
     5VOID(999),VGJ(999),ZABLAT(999),ZABOLD(999),DCRUST(999),
     6DCROLD(999),DABCON(999),DABOLD(999),DFILMT(999),DFOLT(999),
     7SMFLX(4,999),XLSMF(4,999),TOTVOL,XFACMS(999),XMFLXA,XMCORT,
     8VCORT,TOTOX,TOTMET,QFLXT,QFLXB,TIME,DTIME,XMCOR(16),VCOR(16),
     9TCONI,RSAND,HDOWNC,TBOUND,EMISCN,PDRYWL,XDISTO(999),QOXT(999),
     1XLENSH,XBTWO(999),RCOMP,WDOOR,RSUMP,RSHELL,RPED,TPED,ELSMP,
     1TENDP(10,999),TFRZSH,TDEBRS,TKDEBR,PDEBR,CPDEBR,ENENDP(10,999),
     2ENOLDP(10,999),DXVERT,DXSNK,XDSTE(10,999),XBTE(10,999),HXLA(999),
     3HXLB(999),TSFEB(999),DCRS(999),DCRSLD(999),HCRS(16,999),
     4HCRSLD(16,999),THETE0(10,999),THETE1(10,999),QSHELL,QSHELE,TSHELI,
     5SIGOXE(999),FKOXE(999),RINJC,XLSEC,ANGSEC,ANINJC,XLCHAN,WCHNL,
     6TEFZX(999),TIMSPC(999),DXNODE(999),TNORM(999),FRCSOL(999),
     7ALPSPR(999),CRAMCON,HINTF,TSHLMX,XFRMX(999),XFROX(999),XFRTX(999),
     8XMLMX(999),XMLOX(999),XMLTX(999),XTOTX(999),TIMEO,TMAX,EDOWN(999),
     9HCP(999)
      COMMON/HCONS/HMETAL(999),HOXIDE(999)  
      COMMON/PROPI/ NMATC,NMATFI,NMATFF,ICAOH2,ICACO3,IMCCO3,IFH2O,     
     1IVH2O,ICK2O,IVK2O,INA2O,ITIO2,ISIO2,ICAO,IMGO,IAL2O3,IFEO,IFE2O3, 
     2IFE3O4,IFE,ICR,INI,IZR,IU,IB4C,IB,ICR2O3,INIO,IUO2,IZRO2,IB2O3,   
     3NBCINT(999),NODES(999),NUMNOD,IMOX(28),IBAS,ILCS,ILL,NACTIV(999),     
     4NBFRZM,NBFRZO,NABLFM,NDRNFM,NTYPMT(999,999),NDOOR,NBMADJ,NUMSHV,   
     5NBSHL(999),NCRSTS(999),NUMSHH,NSKIPE,NACSH,NWAT,NPEND,NBCBOT,
     6NCRTOP,NBFZOE,NBFZME,NGEOM,NL(999,999),NFRSCT,NLOGSH,NADAB,NINVIS,
     7NSIMST,NSTEEL,NOVHT,NOVTK,NOVUM,NOVEM,NOVSIG,NPLLOC(999),NBPL,
     8IXP(999),IYP(999),NVTPE,NSOLTP,NSOLF,NINTF,IFLGA(999),ICTYPE,ICTC,
     9NPOURS,NSMP,NPED,NDOR,NSHL,NANULS,NSMPCV,NBOIL,NSWALL,NMVER,
     1NCRTEM,NTHINC,NVELP,NITMAX,NENMAX,NPRINT,NPFREQ,NTIMSPC,NPLFREQ,
     2NPLTOT,NJET,NJETP,NJETD,NJETND,NODCAP,NVELPW,NITMAXW,NENMXW,
     3IFLGJ(999),NBEDCQ,ISHELE
      COMMON/PRINTR/ QFEH2O,QCRH2O,QZRH2O,QFECO2,QCRCO2,QZRCO2,
     4XFH2OU,XFCAOH,XFMGCA,XFCACO,XZRMRE,XFEMRE,XCRMRE,XZRORE,XFEORE,   
     5XCRORE,XMH2O,XMCO2,XMCACO,XMMGCA,XMCAOH,TFWL,TFWS,TBWL,TBWS,      
     6TMCAL,TMCAS,TCAL,TCAS,TFOS,TFOL,TFMS,TFML,XVISC(28),SVISC(28),    
     7XMOL(28),FMMOL(28),ROM(28),ROMLIQ(28),AEQM(28,2),BEQM(28,2),
     8CEQM(28,2),ECL,ECS,ECAL,ECAS,EMCAL,EMCAS,EBWL,EBWS,EFWL,EFWS,    
     9STEF,GRAV,PI,TCS,TCL,CCL,CCS,RMASSL,WPCC,WPM,WPA,WPCS,ROC,RMASSS,   
     1ANGSHL,RSLAGL,RSLAGS,HNODT,VFAV,VGAV,QXAV,XWTSS(16),  
     2TSCS(2),TSCL(2),ESCS(2),ESCL(2),CCSS(2),CCSL(2),ROSTLS,ROSTLL,
     3XFRGAS,HMINC,TST(99),TSTOP(99),AINTP(99),BINTP(99),DRATIO(999),
     4XBCN(999),XDCN(999),XBLT(15),ADEC(99),BDEC(99),APOUR(16,99),
     5BPOUR(16,99),XWTC(14),BWIDTH,THCKCV,TMBOIL,TEBOIL,VFINT,ANGFAN,
     6ALPMAX,THSHL,XFCABL,XNDMIN,DVMX,DAVMX,DEAVMX,DEMX,TDC,QDCU,QDCUO2,
     7TSINJ,EINJ,DTINJ,TKINJ,ROEV,CPINJ,SURFT,VSINJ,EMINJ,TSINJO,EINJO,
     8DTINJO,TKINJO,ROEVO,CPINJO,SURFTO,VSINJO,EMINJO,XLEADE,ARSUM,
     9DBUBOX,UTRISE,TREMSH,DJET,DFALL,WEBER,FROUDE,XPSAITO,XPEPSTN,
     1FRAG,XMBEDT,XMBED(16),XLPENT,XLPENA,UJET,UFALL,HFALL,ERPV,
     2TJETT(99),DJETT(99),HWATP,XDOTJET,DVMXW,DAVMXW,DEMXW,DEAVMXW,
     3QJETW,XSTMJF,TINTSJF,ESAT,DRDOOR,DRANL,EI,QDCBUO2,QDCBU,
     4EBEDS,EBEDB
      COMMON/BASPR/ HBMT(999,999,16),HBMOLD(999,999,16) 
      COMMON/PROPB/CPBM(999),FKB(999,999),DENB(999,999),DTDEB(999,999),
     1EMIBM(999),DENCRS(999),ENCRS(999),FKRF(999),DENRF(999),CPRF(999) 
C.....MARCH THROUGH THE MESH TO SEE IF ANY CHANGES ARE NEEDED....
      DO 3710 KH=1,NUMNOD
      IF(NACTIV(KH).EQ.0.OR.NADAB.EQ.1) GO TO 3710      
      NFAILA=0
      NFAILC=0
      GO TO(3710,871,871,872,872,873,873,873,873),NBCINT(KH)  
  871 CONTINUE
      IF(HTOT(KH).LE.0.D0) NFAILC=1
      IF(NCRSTM(KH).EQ.2) GO TO 773
      IF(HOXIDE(KH).LE.0.D0.AND.DCRUST(KH).GT.DCROLD(KH)) NFAILC=1
      GO TO 774
  773 CONTINUE
      IF(HMETAL(KH).LE.0.D0.AND.DCRUST(KH).GT.DCROLD(KH)) NFAILC=1
  774 CONTINUE
      IF(NFAILC.EQ.0) GO TO 3710
      NBCEND=1
      GO TO 3711      
  872 CONTINUE
      IF(ZABLAT(KH).GT.ZABOLD(KH)) NFAILA=1
      IF(NFAILA.EQ.0) GO TO 3710
      NBCEND=1
      GO TO 3711      
  873 CONTINUE
      IF(HTOT(KH).LE.0.D0) NFAILC=1
      IF(NCRSTM(KH).EQ.2) GO TO 973
      IF(HOXIDE(KH).LE.0.D0) NFAILC=1
      GO TO 1973
  973 CONTINUE
      IF(HMETAL(KH).LE.0.D0) NFAILC=1
 1973 CONTINUE
      IF(ZABLAT(KH).GT.ZABOLD(KH)) NFAILA=1
      IF(NFAILC.EQ.0.AND.NFAILA.EQ.0) GO TO 3710    
      NFAILT=NFAILA+NFAILC      
      IF(NFAILT.EQ.2.OR.NFAILC.EQ.1) GO TO 3712     
      IF(NBCINT(KH).EQ.6.OR.NBCINT(KH).EQ.8) NBCEND=2
      IF(NBCINT(KH).EQ.7.OR.NBCINT(KH).EQ.9) NBCEND=3
      GO TO 3711      
 3712 CONTINUE
      NBCEND=1
 3711 CONTINUE
C.....ROUTE TO APPROPRIATE PROCEDURAL BLOCKS TO (1) RE-INDEX BASEMAT    
C.....WHEN BOUNDARY NODES ARE SUFFICIENTLY ABLATED, (2) NODALIZE MOLTEN 
C.....FILMS, OR (3) NODALIZE CRUST, DEPENDING ON THE VALUES OF NBC AND  
C.....NBCEND.
      IF(NBCINT(KH).LE.3) GO TO 3713      
      ZMIN=XDISTO(KH)-XBTWO(KH) 
      IF(ZABLAT(KH).GT.ZMIN) GO TO 3713   
      ZBOLD=ZABLAT(KH)
      NODES(KH)=NODES(KH)-1     
      
      ZABLAT(KH)=ZABLAT(KH)+XDIST(2,KH)   
      ZABOLD(KH)=ZABLAT(KH)
      XDISTO(KH)=XDIST(2,KH)+ZBOLD
      XBTWO(KH)=XBTW(2,KH)+ZBOLD
      DO 3714 KGS=1,4 
      IF(NUMS(KGS,KH).GT.2) GO TO 5921   
      XLENLD=XLSMF(KGS,KH)      
      IF(NUMS(KGS,KH).EQ.2) XLENLD=ZBOLD+XLSMF(KGS,KH)
      NUMS(KGS,KH)=1  
      XLSMF(KGS,KH)=XLENLD      
      GO TO 3714      
 5921 CONTINUE
      NUMS(KGS,KH)=NUMS(KGS,KH)-1
 3714 CONTINUE
      DO 3717 KV=1,NODES(KH)    
      ZMULT=1.D0      
      IF(KV.EQ.1) ZMULT=(ZBOLD+XBTW(2,KH))/XBTW(2,KH)
      DO 3715 KTP=1,16
      HBMT(KV,KH,KTP)=HBMT(KV+1,KH,KTP)*ZMULT
 3715 CONTINUE
      DTDEB(KV,KH)=DTDEB(KV+1,KH)
      NTYPMT(KV,KH)=NTYPMT(KV+1,KH)
      NL(KV,KH)=NL(KV+1,KH)     
      IF(KV.GT.1) GO TO 3097    
      XDIST(KV,KH)=XDIST(KV+1,KH)+ZBOLD   
      XBTW(KV,KH)=XBTW(KV+1,KH)+ZBOLD     
      GO TO 3717      
 3097 CONTINUE
      XDIST(KV,KH)=XDIST(KV+1,KH)
      XBTW(KV,KH)=XBTW(KV+1,KH) 
      TEMP(KV,KH)=TEMP(KV+1,KH) 
      ENTHP(KV,KH)=ENTHP(KV+1,KH)
      EMAX(KV,KH)=EMAX(KV+1,KH) 
 3717 CONTINUE
 3713 CONTINUE
      IF(NBCINT(KH).EQ.3.OR.NBCINT(KH).EQ.4) GO TO 3718
      IF(NBCINT(KH).EQ.2) GO TO 3720     
      IF(NBCINT(KH).EQ.7) GO TO 3718      
      IF(NBCINT(KH).EQ.6.AND.NBCEND.NE.1) GO TO 3718
      IF(NBCINT(KH).EQ.6.AND.NBCEND.EQ.1) GO TO 3720
      IF(NBCINT(KH).EQ.5) NPASS(KH)=1     
      IF(NBCEND.EQ.2.OR.NBCEND.EQ.3) NPASS(KH)=1    
C.....NODALIZE MOLTEN FILM.  FIRST FIND FILM/MELT OR FILM/CRUST
C.....INTERFACIAL TEMPERATURE, DEPENDING UPON THE BOUNDARY CONDITION.   
      CALL ASINEA(DFILM,KH,HSEND,ROMLIQ,WPCC,WPM,WPA,WPCS,ROC,RSLAGL,0) 
      CALL CONDF(TEMP(1,KH),HSEND,FKO,FKM,TKMOL)    
      IF(NBCINT(KH).EQ.5) GO TO 3722      
      TFREEZ=TFOS     
      IF(NCRSTM(KH).EQ.2) TFREEZ=TFMS    
      CALL ASINEA(HCRUST,KH,HSEND,ROM,WPCC,WPM,WPA,WPCS,ROC,RSLAGS,NCRST
     1M(KH))
      IF(NBCINT(KH).EQ.8) GO TO 1819      
      TINT=TEMP(1,KH)+(HTCOEF(KH)*DFILMT(KH)*(TBULK(KH)-TFREEZ))/TKMOL  
      GO TO 3721      
 1819 CONTINUE
      CALL CONDF(TFREEZ,HSEND,FKO,FKM,TKOXD)
      C1=TKOXD/DCRUST(KH)+TKMOL/DFILMT(KH)
      C2=(TKOXD*TFREEZ)/DCRUST(KH)+(TKMOL*TEMP(1,KH))/DFILMT(KH)
      TINT=C2/C1      
      GO TO 3721      
 3722 CONTINUE
      C1=HTCOEF(KH)+TKMOL/DFILMT(KH)      
      C2=HTCOEF(KH)*TBULK(KH)+(TKMOL*TEMP(1,KH))/DFILMT(KH)   
      TINT=C2/C1      
 3721 CONTINUE
      CALL ASINEA(DFILM,KH,HSEND,ROMLIQ,WPCC,WPM,WPA,WPCS,ROC,RSLAGL,0) 
      CALL ETF(ESF,HSEND,TINT,DTDES)      
      TSTORE=TEMP(1,KH)
      ESTORE=ENTHP(1,KH)
      TEMP(1,KH)=TINT 
      ENTHP(1,KH)=ESF 
      DTDEB(1,KH)=DTDES
C.....DETERMINE WHETHER THE MOLTEN FILM IS PRIMARILY OXIDIC OR METALLIC.
      DFMM=0.D0
      DFMO=0.D0
      DO 3723 KTP=1,16
      IF(KTP.LE.7) DFMM=DFMM+DFILM(KTP,KH)
      IF(KTP.GE.8) DFMO=DFMO+DFILM(KTP,KH)
 3723 CONTINUE
      DFMT=DFMM+DFMO  
      DENOM=0.D0
      IF(DFMT.GT.0.D0) DENOM=1.0/DFMT
      DFFOX=DENOM*DFMO
      NTPN=4
      IF(DFFOX.GT.0.5D0) NTPN=5 
C.....CONSTRUCT NODAL CELL.     
      NODES(KH)=NODES(KH)+1     
      IF(NODES(KH).GT.NODCAP) NODES(KH)=NODCAP      
      DO 3726 KDR=1,NODES(KH)-2 
      IEV=NODES(KH)-KDR+1
      DO 3728 KTP=1,16
      HBMT(IEV,KH,KTP)=HBMT(IEV-1,KH,KTP) 
 3728 CONTINUE
      DTDEB(IEV,KH)=DTDEB(IEV-1,KH)
      NTYPMT(IEV,KH)=NTYPMT(IEV-1,KH)     
      NL(IEV,KH)=NL(IEV-1,KH)   
      XDIST(IEV,KH)=XDIST(IEV-1,KH)
      XBTW(IEV,KH)=XBTW(IEV-1,KH)
      TEMP(IEV,KH)=TEMP(IEV-1,KH)
      ENTHP(IEV,KH)=ENTHP(IEV-1,KH)
      EMAX(IEV,KH)=EMAX(IEV-1,KH)
 3726 CONTINUE
      XMID=0.5D0*ZABLAT(KH)-0.5D0*(XDISTO(KH)-XBTWO(KH))      
      XDIST(2,KH)=XMID+XDISTO(KH)-XBTWO(KH)
      XBTW(2,KH)=XMID 
      XBTW(1,KH)=DFILMT(KH)     
      XDIST(1,KH)=DFILMT(KH)+XMID
      IF(NTYPMT(1,KH).GT.3) GO TO 6563    
      FMULTF=1.D0+(XMID/ZABLAT(KH))*(TEMP(2,KH)/TSTORE-1.D0)  
      ENTHP(2,KH)=ESTORE*FMULTF 
      EMAX(2,KH)=EMAX(1,KH)*FMULTF
      GO TO 6564      
 6563 CONTINUE
      TEMP(2,KH)=TSTORE+(TEMP(2,KH)-TSTORE)*(XMID/ZABLAT(KH)) 
 6564 CONTINUE
      NTYPMT(2,KH)=NTYPMT(1,KH) 
      NL(2,KH)=NL(1,KH)
      NTYPMT(1,KH)=NTPN
      NL(1,KH)=0      
      IF(NTYPMT(2,KH).LE.3) GO TO 3729    
      CALL ASINED(1,KH,HSEND,ROM,WPCC,WPM,WPA,WPCS,ROC,RSLAGS,0)
      CALL TEF(ENTHP(2,KH),HSEND,TEMP(2,KH),DTDEB(2,KH))      
      DO 3730 KTP=1,16
      HBMT(2,KH,KTP)=HBMT(1,KH,KTP)
 3730 CONTINUE
      GO TO 3731      
 3729 CONTINUE
      CALL TEC(ENTHP(2,KH),EMAX(2,KH),TEMP(2,KH),DTDE,RMASS,YCACO3,YMCCO
     13,YCAOH2,YFH2O,NL(2,KH))  
      DTDEB(2,KH)=DTDE
 3731 CONTINUE
      DGAS=DFILMT(KH) 
      DFILMT(KH)=0.D0 
      ZABLAT(KH)=XDIST(1,KH)    
      ZABOLD(KH)=ZABLAT(KH)
      XDISTO(KH)=XDIST(1,KH)    
      XBTWO(KH)=XBTW(1,KH)      
      DO 3732 KTP=1,16
      HBMT(1,KH,KTP)=DFILM(KTP,KH)
      DFILM(KTP,KH)=0.D0
 3732 CONTINUE
      DO 3733 KGS=1,4 
      IF(NUMS(KGS,KH).GT.1) GO TO 3736    
      XLCOMP=XLSMF(KGS,KH)-XMID 
      IF(XLCOMP.GT.0.D0) GO TO 3734
      XLSMF(KGS,KH)=XLSMF(KGS,KH)+DGAS    
      NUMS(KGS,KH)=1  
      GO TO 3733      
 3734 CONTINUE
      XLSMF(KGS,KH)=XLCOMP      
      NUMS(KGS,KH)=NUMS(KGS,KH)+1
      GO TO 3733      
 3736 CONTINUE
      NUMS(KGS,KH)=NUMS(KGS,KH)+1
 3733 CONTINUE
      IF(NBCINT(KH).EQ.5) GO TO 3718      
      IF(NBCINT(KH).EQ.9) GO TO 3718      
      IF(NBCEND.EQ.2) GO TO 3718
C.....NODALIZE THE CRUST AND INCORPORATE THE MATERIAL INTO THE BASEMAT. 
 3720 CONTINUE
      NODES(KH)=NODES(KH)+1     
      IF(NODES(KH).GT.NODCAP) NODES(KH)=NODCAP      
      DO 3751 KDR=1,NODES(KH)-2 
      IEV=NODES(KH)-KDR+1
      DO 3753 KTP=1,16
      HBMT(IEV,KH,KTP)=HBMT(IEV-1,KH,KTP) 
 3753 CONTINUE
      DTDEB(IEV,KH)=DTDEB(IEV-1,KH)
      NTYPMT(IEV,KH)=NTYPMT(IEV-1,KH)     
      NL(IEV,KH)=NL(IEV-1,KH)   
      XDIST(IEV,KH)=XDIST(IEV-1,KH)
      XBTW(IEV,KH)=XBTW(IEV-1,KH)
      TEMP(IEV,KH)=TEMP(IEV-1,KH)
      ENTHP(IEV,KH)=ENTHP(IEV-1,KH)
      EMAX(IEV,KH)=EMAX(IEV-1,KH)
 3751 CONTINUE
      NTYPMT(2,KH)=NTYPMT(1,KH) 
      NL(2,KH)=NL(1,KH)
      XMID=0.5D0*ZABLAT(KH)-0.5D0*(XDISTO(KH)-XBTWO(KH))      
      FMULTF=1.D0+(XMID/ZABLAT(KH))*(TEMP(2,KH)/TEMP(1,KH)-1.D0)
      ENTHP(2,KH)=ENTHP(1,KH)*FMULTF      
      EMAX(2,KH)=EMAX(1,KH)*FMULTF
      IF(NTYPMT(2,KH).LE.3) GO TO 3754    
      CALL ASINED(1,KH,HSEND,ROM,WPCC,WPM,WPA,WPCS,ROC,RSLAGS,0)
      CALL TEF(ENTHP(2,KH),HSEND,TEMP(2,KH),DTDE)   
      DTDEB(2,KH)=DTDE
      DO 3755 KTP=1,16
      HBMT(2,KH,KTP)=HBMT(1,KH,KTP)
 3755 CONTINUE
      GO TO 3756      
 3754 CONTINUE
      CALL TEC(ENTHP(2,KH),EMAX(2,KH),TEMP(2,KH),DTDE,RMASS,YCACO3,YMCCO
     13,YCAOH2,YFH2O,NL(2,KH))  
 3756 CONTINUE
      XBTW(2,KH)=XMID 
      XDIST(2,KH)=XMID+XDISTO(KH)-XBTWO(KH)
      IF(NCRSTM(KH).EQ.2) GO TO 3757     
      TEMP(1,KH)=TFOS 
      KINL=1
      KINH=7
      KOUTL=8
      KOUTH=16
      GO TO 3758      
 3757 CONTINUE
      TEMP(1,KH)=TFMS 
      KINL=8
      KINH=16
      KOUTL=1
      KOUTH=7
 3758 CONTINUE
      DO 3759 KTP=KINL,KINH     
      HBMT(1,KH,KTP)=0.D0
      HCRUST(KH,KTP)=0.D0
 3759 CONTINUE
      DO 3760 KTP=KOUTL,KOUTH   
      HBMT(1,KH,KTP)=HCRUST(KTP,KH)
      HBMOLD(1,KH,KTP)=HBMT(1,KH,KTP)     
      HCRUST(KTP,KH)=0.D0
 3760 CONTINUE
      CALL ASINED(1,KH,HSEND,ROM,WPCC,WPM,WPA,WPCS,ROC,RSLAGS,0)
      CALL ETF(ENTHP(1,KH),HSEND,TEMP(1,KH),DTDEB(1,KH))      
      NTYPMT(1,KH)=5  
      IF(NCRSTM(KH).EQ.2) NTYPMT(1,KH)=4 
      NL(1,KH)=0      
      XDIST(1,KH)=DCRUST(KH)+XMID
      XBTW(1,KH)=DCRUST(KH)     
      ZGASCR=XBTW(1,KH)
      ZMOVE=XMID      
      XDISTO(KH)=XDIST(1,KH)    
      XBTWO(KH)=XBTW(1,KH)      
      DCRUST(KH)=0.D0 
      ZABLAT(KH)=XDISTO(KH)     
      ZABOLD(KH)=ZABLAT(KH)
      DO 3761 KGS=1,4 
      IF(NUMS(KGS,KH).GT.1) GO TO 3762    
      XLCOMP=XLSMF(KGS,KH)-ZMOVE
      IF(XLCOMP.GT.0.D0) GO TO 7654
      XLSMF(KGS,KH)=XLSMF(KGS,KH)+ZGASCR  
      NUMS(KGS,KH)=1  
      GO TO 3761      
 7654 CONTINUE
      XLSMF(KGS,KH)=XLSMF(KGS,KH)-ZMOVE+ZGASCR      
      NUMS(KGS,KH)=1  
      GO TO 3761      
 3762 CONTINUE
      NUMS(KGS,KH)=NUMS(KGS,KH)+1
 3761 CONTINUE
 3718 CONTINUE
      NBCINT(KH)=NBCEND
 3710 CONTINUE
      RETURN
      END