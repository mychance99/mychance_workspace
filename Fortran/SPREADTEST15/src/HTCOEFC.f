C...................................................................... 
C.....SUBROUTINE HTCOEFC CALCULATES MELT-TO-BASEMAT AND MELT/SOLDIFIED 
C.....DEBRIS-TO-ATMOSPHERE (WET OR DRY) HEAT TRANSFER COFFICIENTS.
C...................................................................... 
      SUBROUTINE HTCOEFC
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      REAL(8) KL
      COMMON/CATCHR/A(999),B(999),C(999),D(999),P(999),Q(999),
     1RECON(999),DELVEL(999),DSRDT(999),DELHTS(999),EMAX(999,999),
     2DBLKEN(999),DELHIT(16,999),SOURCE(16,999),SRCTOT(999),
     3HCROLD(16,999),DCDOT(999),HCRUST(16,999),DFILM(16,999),
     4DFMOLD(16,999),DENOLD(999),SIGOX(999),SIGCON(999),BET(999),
     5TFZX(999),TFZC(999),TKX(999),TKM(999),THETO(999,999),
     6THET1(999,999),OMEG0(4,999),OMEG1(4,999),TAO0(999),TAO1(999),
     7SIG0(999),SIG1(999),TARGB(999),DADOT(999),DADOTG(999),
     8XLOLD(4,999),VISREX(999),TATMS(999),HTMP(999),DHTMP(999),
     9HTMOLD(999)
      COMMON/PRINTB/ELEVAT(999),ELOLD(999),XDIST(999,999),XBTW(999,999),
     1TEMP(999,999),ENTHP(999,999),EOLD(999,999),ENBLK(999),EBKOLD(999),
     2TBULK(999),HITE(16,999),HITOLD(16,999),HTOT(999),HTOLD(999),
     3HTCFT(999),HTCOEF(999),QFLUXT(999),QFLUXB(999),VEL(999),ELO(999),
     4VELOLD(999),SRSCOR(16),AREA(999),RAD(999),ARC(999),VOLCN(16),
     5VOID(999),VGJ(999),ZABLAT(999),ZABOLD(999),DCRUST(999),
     6DCROLD(999),DABCON(999),DABOLD(999),DFILMT(999),DFOLT(999),
     7SMFLX(4,999),XLSMF(4,999),TOTVOL,XFACMS(999),XMFLXA,XMCORT,
     8VCORT,TOTOX,TOTMET,QFLXT,QFLXB,TIME,DTIME,XMCOR(16),VCOR(16),
     9TCONI,RSAND,HDOWNC,TBOUND,EMISCN,PDRYWL,XDISTO(999),QOXT(999),
     1XLENSH,XBTWO(999),RCOMP,WDOOR,RSUMP,RSHELL,RPED,TPED,ELSMP,
     1TENDP(10,999),TFRZSH,TDEBRS,TKDEBR,PDEBR,CPDEBR,ENENDP(10,999),
     2ENOLDP(10,999),DXVERT,DXSNK,XDSTE(10,999),XBTE(10,999),HXLA(999),
     3HXLB(999),TSFEB(999),DCRS(999),DCRSLD(999),HCRS(16,999),
     4HCRSLD(16,999),THETE0(10,999),THETE1(10,999),QSHELL,QSHELE,TSHELI,
     5SIGOXE(999),FKOXE(999),RINJC,XLSEC,ANGSEC,ANINJC,XLCHAN,WCHNL,
     6TEFZX(999),TIMSPC(999),DXNODE(999),TNORM(999),FRCSOL(999),
     7ALPSPR(999),CRAMCON,HINTF,TSHLMX,XFRMX(999),XFROX(999),XFRTX(999),
     8XMLMX(999),XMLOX(999),XMLTX(999),XTOTX(999),TIMEO,TMAX,EDOWN(999),
     9HCP(999)
      COMMON/HCONS/HMETAL(999),HOXIDE(999)  
      COMMON/PROPI/ NMATC,NMATFI,NMATFF,ICAOH2,ICACO3,IMCCO3,IFH2O,     
     1IVH2O,ICK2O,IVK2O,INA2O,ITIO2,ISIO2,ICAO,IMGO,IAL2O3,IFEO,IFE2O3, 
     2IFE3O4,IFE,ICR,INI,IZR,IU,IB4C,IB,ICR2O3,INIO,IUO2,IZRO2,IB2O3,   
     3NBCINT(999),NODES(999),NUMNOD,IMOX(28),IBAS,ILCS,ILL,NACTIV(999),     
     4NBFRZM,NBFRZO,NABLFM,NDRNFM,NTYPMT(999,999),NDOOR,NBMADJ,NUMSHV,   
     5NBSHL(999),NCRSTS(999),NUMSHH,NSKIPE,NACSH,NWAT,NPEND,NBCBOT,
     6NCRTOP,NBFZOE,NBFZME,NGEOM,NL(999,999),NFRSCT,NLOGSH,NADAB,NINVIS,
     7NSIMST,NSTEEL,NOVHT,NOVTK,NOVUM,NOVEM,NOVSIG,NPLLOC(999),NBPL,
     8IXP(999),IYP(999),NVTPE,NSOLTP,NSOLF,NINTF,IFLGA(999),ICTYPE,ICTC,
     9NPOURS,NSMP,NPED,NDOR,NSHL,NANULS,NSMPCV,NBOIL,NSWALL,NMVER,
     1NCRTEM,NTHINC,NVELP,NITMAX,NENMAX,NPRINT,NPFREQ,NTIMSPC,NPLFREQ,
     2NPLTOT,NJET,NJETP,NJETD,NJETND,NODCAP,NVELPW,NITMAXW,NENMXW,
     3IFLGJ(999),NBEDCQ,ISHELE
      COMMON/PRINTR/ QFEH2O,QCRH2O,QZRH2O,QFECO2,QCRCO2,QZRCO2,
     4XFH2OU,XFCAOH,XFMGCA,XFCACO,XZRMRE,XFEMRE,XCRMRE,XZRORE,XFEORE,   
     5XCRORE,XMH2O,XMCO2,XMCACO,XMMGCA,XMCAOH,TFWL,TFWS,TBWL,TBWS,      
     6TMCAL,TMCAS,TCAL,TCAS,TFOS,TFOL,TFMS,TFML,XVISC(28),SVISC(28),    
     7XMOL(28),FMMOL(28),ROM(28),ROMLIQ(28),AEQM(28,2),BEQM(28,2),
     8CEQM(28,2),ECL,ECS,ECAL,ECAS,EMCAL,EMCAS,EBWL,EBWS,EFWL,EFWS,    
     9STEF,GRAV,PI,TCS,TCL,CCL,CCS,RMASSL,WPCC,WPM,WPA,WPCS,ROC,RMASSS,   
     1ANGSHL,RSLAGL,RSLAGS,HNODT,VFAV,VGAV,QXAV,XWTSS(16),  
     2TSCS(2),TSCL(2),ESCS(2),ESCL(2),CCSS(2),CCSL(2),ROSTLS,ROSTLL,
     3XFRGAS,HMINC,TST(99),TSTOP(99),AINTP(99),BINTP(99),DRATIO(999),
     4XBCN(999),XDCN(999),XBLT(15),ADEC(99),BDEC(99),APOUR(16,99),
     5BPOUR(16,99),XWTC(14),BWIDTH,THCKCV,TMBOIL,TEBOIL,VFINT,ANGFAN,
     6ALPMAX,THSHL,XFCABL,XNDMIN,DVMX,DAVMX,DEAVMX,DEMX,TDC,QDCU,QDCUO2,
     7TSINJ,EINJ,DTINJ,TKINJ,ROEV,CPINJ,SURFT,VSINJ,EMINJ,TSINJO,EINJO,
     8DTINJO,TKINJO,ROEVO,CPINJO,SURFTO,VSINJO,EMINJO,XLEADE,ARSUM,
     9DBUBOX,UTRISE,TREMSH,DJET,DFALL,WEBER,FROUDE,XPSAITO,XPEPSTN,
     1FRAG,XMBEDT,XMBED(16),XLPENT,XLPENA,UJET,UFALL,HFALL,ERPV,
     2TJETT(99),DJETT(99),HWATP,XDOTJET,DVMXW,DAVMXW,DEMXW,DEAVMXW,
     3QJETW,XSTMJF,TINTSJF,ESAT,DRDOOR,DRANL,EI,QDCBUO2,QDCBU,
     4EBEDS,EBEDB
      COMMON /WATVARS/FCRUST(999),VLW(999),VLWOLD(999),DWAT(999),
     1DWATOLD(999),EWAT(999),EWATOLD(999),TWAT(999),CORDDC(999),
     2DSRDC(999),DHDC(999),TSRDC,TINTDC,HWATB(999),TSURFW(999),XMS(999),
     3XMST,XINTS,ESRDTW(999),TSRDTW(999),DSRDTW(999),TSRDW,TINTDW,
     4TWATI,ELDCO(999),ELDCX(999,99),CRDCX(999,99),TIMINJ(999,99),
     5XDTINJ(999,99),TDTINJ(999,99),ELWATI,XMWAT,XMWATO,XBALW,
     6HDRY(999),EINTW,XMCT(199),XMCDT(16,999),TMPCDT(999),CMPCDT(999),
     7FDC(999),FCOV(999),FBED(999),FHEAT(999),XFACJ(999),
     8XMBEDJ(16,999),XMBEDJT(999),PBED,QBED(999),QWATER(999),
     9QSURFACE(999),QWATERT(999),HBED(999),POROSBED,XMCRDT(16,999),
     1XMCRT(999),XMBDINT(999),XMT(999)
      COMMON/BLKHT/TKMLT,PM,CM,UM,EMISM,SIGMAM,TKNC,PNC,CNC,UNC    
      COMMON/PROPB/CPBM(999),FKB(999,999),DENB(999,999),DTDEB(999,999),
     1EMIBM(999),DENCRS(999),ENCRS(999),FKRF(999),DENRF(999),CPRF(999) 
      COMMON/PROPM/DTDEM(999),CPMLT(999),FKMLT(999),DENMLT(999),
     1SIGMLT(999),UMMLT(999),EMIMLT(999)      
      AHYDR=0.D0      
C.....GET WATER SATURATION TEMPERATURE IF NEEDED
      IF(NWAT.GT.0) CALL CONWAT(TSAT,KL,PL,CL,UL,HLV,EWL,EWV,CWV,SIGMA,
     1PDRYWL)
C.....SET HT COEFFICIENT EQUAL TO ZERO UNLESS MELT IS PRESENT.
      DO 7311 J=1,NUMNOD
      HWATB(J)=0.D0
      TSURFW(J)=TCONI
      TSUB=0.D0
      IF(NWAT.EQ.2) TSUB=DMAX1(TSAT-TWAT(J),0.D0)
      IF(NACTIV(J).EQ.0) GO TO 7311
      IF(NADAB.EQ.1) GO TO 7311
C.....MELT PRESENT MOVE ON.   
      ZCOMP=XDISTO(J)-ZABLAT(J) 
      IP=2  
      IF(ZCOMP.LT.XBTWO(J)) IP=1
      HFUSS=(2.D0*SIGCON(J)*DTIME)/DENB(IP,J)
      IF(VGJ(J).GT.0.D0) GO TO 4239
      FRAH2O=1.D0     
      FRACO2=0.D0     
      GO TO 4240      
 4239 CONTINUE
      FRADEN=(SMFLX(1,J)+SMFLX(2,J))/XMH2O+(SMFLX(3,J)+SMFLX(4,J))/XMCO2
      FRAH2O=(SMFLX(1,J)+SMFLX(2,J))/(XMH2O*FRADEN) 
      FRACO2=(SMFLX(3,J)+SMFLX(4,J))/(XMCO2*FRADEN) 
      FRAH2O=DMAX1(0.D0,FRAH2O) 
      FRACO2=DMAX1(0.D0,FRACO2) 
      FRAH2O=DMIN1(1.D0,FRAH2O) 
      FRACO2=DMIN1(1.D0,FRACO2) 
 4240 CONTINUE
      TAV=0.5D0*(TCS+TSAT)
      CALL CONCO2(TAV,PDRYWL,CPC,VISC,FKC,DENC)     
      CALL CONH2O(TAV,PDRYWL,CPH,VISH,FKH,DENH)     
      TKNC=FRAH2O*FKH+FRACO2*FKC
      PNC=FRAH2O*DENH+FRACO2*DENC
      CNC=FRAH2O*CPH+FRACO2*CPC 
      UNC=FRAH2O*VISH+FRACO2*VISC
      IF(HTOT(J).GT.0.D0) GO TO 8740      
C.....NO MELT PRESENT OVER BASEMAT HERE; CALCULATE BASEMAT-TO-WATER OR  
C.....BASEMAT-TO-ATMOSPHERE HEAT TRANSFER COEFFICIENT, DEPENDING UPON   
C.....WHETHER OR NOT WATER IS PRESENT.    
      TEVAL=TEMP(1,J) 
      IF(NWAT.EQ.0) GO TO 9741
      IF(DWAT(J).GT.0.D0) GO TO 8741
C.....BASEMAT-TO-ATMOSPHERE HEAT TRANSFER COEFFICIENT DETERMINED HERE.  
 9741 CONTINUE
      TARGB(J)=TBOUND 
      VIEWU=STEF*(TEVAL+TBOUND)*(TEVAL*TEVAL+TBOUND*TBOUND)   
      VIEWD=(1.D0/EMIBM(J)+1.D0/EMISCN-1.D0)
      HTCOEF(J)=VIEWU/VIEWD     
      HTCFT(J)=0.D0   
      TSURFW(J)=TEVAL
      HWATB(J)=0.D0
      HDRY(J)=HTCOEF(J)
      GO TO 7311      
 8741 CONTINUE
C.....NO MELT, WATER OVER BASEMAT CASE TREATED HERE.
      TARGB(J)=TSAT   
      EMISM=EMIBM(J)  
      TKMLT=FKB(IP,J) 
      PM=DENB(IP,J)   
      CM=CPBM(J)      
      VGSND=0.D0
      CALL WAT(TEVAL,TSUB,VGSND,HTCOEF(J),PDRYWL,HTOT(J))    
      HTCFT(J)=0.D0   
      TSURFW(J)=TEVAL
      IF(NWAT.LE.1) GO TO 7311
      HWATB(J)=HTCOEF(J)
      VIEWU=STEF*(TEVAL+TBOUND)*(TEVAL*TEVAL+TBOUND*TBOUND)   
      VIEWD=(1.D0/EMIBM(J)+1.D0/EMISCN-1.D0)
      QDRY=(VIEWU/VIEWD)*(TEVAL-TBOUND)
      HDRY(J)=0.D0
      IF(TEVAL.GT.TARGB(J)) HDRY(J)=QDRY/(TEVAL-TARGB(J))
      GO TO 7311      
 8740 CONTINUE
C.....CASE IN WHICH MELT IS PRESENT OVER BASEMAT IS TREATED HERE.  FIRST
C.....DETERMINE MELT-TO-BASEMAT INTERFACIAL HEAT TRANSFER COEFFICIENT.  
C.....CASES CONSIDERED ARE: (1) NBCBOT=1 IS CORCON/MOD2 GAS FILM MODEL, 
C.....NBCBOT=2 IS KAO & KAZIMI'S REVISED PERIODIC CONACT MODEL, (3)     
C.....NBCBOT=3 IS DITTUS BOLTLER FORCED CONVECTION HEAT TRANSFER COEF,  
C.....(4) NBCBOT=4 IS A LINEAR SUPERPOSITION OF THE GAS FILM AND FORCED 
C.....CONVECTION HEAT TRANSFER COEFFICIENTS, AND (5) NBCBOT=5 IS A      
C.....LINEAR SUPERPOSITION OF THE PERIODIC CONTACT AND FORCED CONVECTION
C.....COEFFICIENTS.   
      HDEPLY=HTOT(J)  
      HDEPLY=DMAX1(HDEPLY,HMINC)
      TARGB(J)=TBULK(J)
      HCONLIM=(1.9D0*FKMLT(J))/HDEPLY
      GO TO(1193,1194,1195,1193,1194),NBCBOT
 1193 CONTINUE
      IF(VGJ(J).GT.0.D0) GO TO 1291
      HTCOEF(J)=HCONLIM
      HGASF=HTCOEF(J) 
      IF(NBCBOT.EQ.4) GO TO 1195
      GO TO 2228      
 1291 CONTINUE
      ALAP=SQRT(SIGMLT(J)/(GRAV*DENMLT(J)))
      E23=2.D0/3.D0   
      XKUT=(1.D6*CPMLT(J)*VGJ(J)*PDRYWL)/(FKMLT(J)*GRAV)      
      VTRAN=(4.3D-4*SIGMLT(J))/UMMLT(J)   
      C1=(1.50D-3*FKMLT(J)*XKUT**E23)/ALAP
      C2=1.D0
      IF(VGJ(J).GT.VTRAN) C2=SQRT(VTRAN/VGJ(J))     
      C3=0.29
      HTCOEF(J)=C1*C2*C3
      HGASF=HTCOEF(J) 
      IF(NBCBOT.EQ.4) GO TO 1195
      GO TO 2228      
 1194 CONTINUE
      IF(VGJ(J).LE.0.D0) GO TO 2236
      IF(NBCINT(J).GT.3) GO TO 1236
 2236 CONTINUE
      HTCOEF(J)=HCONLIM
      HPCM=HTCOEF(J)  
      IF(NBCBOT.EQ.5) GO TO 1195
      GO TO 2228      
 1236 CONTINUE
      ALAP=SQRT(SIGMLT(J)/(GRAV*DENMLT(J)))
      E13=1.D0/3.D0   
      SLIP=(DENRF(J)/PNC)**E13  
      C2=(1.D0-XFRGAS)*PNC*SLIP 
      C3=XFRGAS*DENRF(J)
      C4=1.D0+C2/C3   
      VDRF=1.D0/C4    
      PRF=PNC*VDRF+DENRF(J)*(1.D0-VDRF)   
      CRF=CNC*XFRGAS+CPRF(J)*(1.D0-XFRGAS)
      TKRF=TKNC*VDRF+FKRF(J)*(1.D0-VDRF)  
      BETBLK=SQRT(FKMLT(J)*DENMLT(J)*CPMLT(J))      
      BETSRF=SQRT(FKB(IP,J)*DENB(IP,J)*CPBM(J))     
      BETSLG=SQRT(TKRF*PRF*CRF) 
      C1=HFUSS
      C2=HFUSS-(CRF*TFZC(J))/3.D0
      C3=CRF/3.D0     
      C4N=BETBLK*TBULK(J)+BETSRF*TFZC(J)  
      C4=C4N/(BETBLK+BETSRF)    
      C5N=BETBLK*TBULK(J)+BETSLG*TFZC(J)  
      C5=C5N/(BETBLK+BETSLG)    
      DENOM=0.D0      
      IF(C4-C5.NE.0.D0) DENOM=1.D0/ABS(C4-C5)
      ETA=(DENOM*(C2+C3*C5))/C3 
      OMG=(DENOM*C1)/C3
      TIMSCL=0.5D0*(-ETA+SQRT(ETA*ETA+4.D0*OMG))    
      TIMSCL=DMAX1(TIMSCL,0.D0) 
      TIMSCL=DMIN1(TIMSCL,1.D0) 
      TINTF=TIMSCL*C4+(1.D0-TIMSCL)*C5    
      C6=(BETBLK*(TBULK(J)-TINTF))/(BETSLG*(TBULK(J)-TFZC(J)))
      C7=(CRF*(TBULK(J)-TFZC(J)))/C1      
      C8=(2.8D0*TKRF*C6*C6)/ALAP
      HTCOEF(J)=C8*C7*TIMSCL*TIMSCL
      HPCM=HTCOEF(J)  
      IF(NBCBOT.EQ.2) GO TO 2228
 1195 CONTINUE
      VELAVE=ABS(VEL(J+1))      
      IF(J.GT.1) VELAVE=ABS(0.5D0*(VEL(J)+VEL(J+1)))
      REJ=(4.D0*HTOT(J)*VELAVE*DENMLT(J))/UMMLT(J)   
      DHYDR=4.D0*HDEPLY
      PRANDT=ABS((CPMLT(J)*UMMLT(J))/FKMLT(J))      
      HTCOEF(J)=(0.023D0*(REJ**0.8D0)*(PRANDT**0.4D0)*FKMLT(J))/DHYDR   
      HTCOEF(J)=DMAX1(HTCOEF(J),HCONLIM)
      HFCONV=HTCOEF(J)
      IF(NBCBOT.EQ.3) GO TO 2228
      IF(VGJ(J).LE.0.D0) GO TO 2228
      IF(NBCBOT.EQ.5) GO TO 2039
      HTCOEF(J)=DMAX1(HFCONV,HGASF)    
      GO TO 2228      
 2039 CONTINUE
      IF(NBCINT(J).LE.3) GO TO 2228
      HTCOEF(J)=DMAX1(HPCM,HFCONV)     
 2228 CONTINUE
C.....IF INTERFACIAL HEAT TRANSFER COEFFICIENT IS TREATED, MAKE THE 
C.....CORRECTION BELOW:
      IF(NINTF.EQ.1) HTCOEF(J)=(HTCOEF(J)*HINTF)/(HTCOEF(J)+HINTF) 
C.....EVALUATE MELT-TO-WATER OR MELT-TO-ATMOSPHERE HEAT TRANSFER
C.....COEFFICIENT IF NO WATER IS PRESENT.  ALSO, ASSESS WHETHER OR NOT  
C.....THE MELT COOLING RATE IS SUFFICIENT TO INDUCE A THIN CRUST
C.....BOUNDARY CONDITION ON THE MELT UPPER SURFACE. 
      HFRM=HMETAL(J)/HTOT(J)  
      TFRZT=TFOS      
      IF(HFRM.GT.0.5D0.AND.TBULK(J).GE.TFMS) TFRZT=TFMS
      TEVAL=TBULK(J)  
      IF(NCRTOP.EQ.1) TEVAL=TFRZT  
      IF(NWAT.EQ.0) GO TO 509
      IF(DWAT(J).LE.0.D0) GO TO 509 
      GO TO 609
  509 CONTINUE
C.....NO WATER HERE....
      RADCST=STEF/(1.D0/EMIMLT(J)+1.D0/EMISCN-1.D0) 
      QTOP=RADCST*(TEVAL**4-TBOUND**4)    
      TATMS(J)=TBOUND 
      IF(NCRTOP.EQ.1) TATMS(J)=TFRZT
      HTCFT(J)=0.D0   
      IF(TBULK(J)-TATMS(J).GT.0.D0) HTCFT(J)=QTOP/(TBULK(J)-TATMS(J))   
      HWATB(J)=0.D0
      TSURFW(J)=TEVAL
      HDRY(J)=HTCFT(J)
      GO TO 7311      
  609 CONTINUE
C.....WATER HERE....
      IF(NCRTOP.EQ.1) GO TO 761    
      TATMS(J)=TSAT   
      GO TO 762
  761 CONTINUE
      TATMS(J)=TFRZT  
  762 CONTINUE
      EMISM=EMIMLT(J) 
      TKMLT=FKMLT(J)  
      PM=DENMLT(J)    
      UM=UMMLT(J)     
      CM=CPMLT(J)     
      SIGMAM=SIGMLT(J)
      CALL WAT(TEVAL,TSUB,VGJ(J),HTTM,PDRYWL,HTOT(J))   
      QTOP=HTTM*(TEVAL-TSAT)    
      HTCFT(J)=0.D0   
      IF(TBULK(J)-TATMS(J).NE.0.D0) HTCFT(J)=QTOP/(TBULK(J)-TATMS(J))   
      HWATB(J)=HTTM
      TSURFW(J)=TEVAL
      VIEWU=STEF*(TEVAL+TBOUND)*(TEVAL*TEVAL+TBOUND*TBOUND)   
      VIEWD=(1.D0/EMIBM(J)+1.D0/EMISCN-1.D0)
      QDRY=(VIEWU/VIEWD)*(TEVAL-TBOUND)
      HDRY(J)=0.D0
      IF(TEVAL.GT.TATMS(J)) HDRY(J)=QDRY/(TEVAL-TATMS(J))
      HDRY(J)=VIEWU/VIEWD     
 7311 CONTINUE
      RETURN
      END