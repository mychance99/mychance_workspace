C...................................................................... 
C.....SUBROUTINE WRAPUP CALCULATES A FEW PIECES OF INFORMATION FOR I/O 
C.....AFTER THE SOLUTION HAS CONVERGED.  THIS INCLUDES THE LOCAL 
C.....OXIDATION ENERGY FLUX WITHIN THE MELT, MELT/ATMOSPHERE HEAT 
C.....FLUXES, AND MASS DISTRIBUTION FUNCTIONS.     
C...................................................................... 
      SUBROUTINE WRAPUP(IFINISH)
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      REAL(8) KL
      DIMENSION HSEND(88)
      COMMON/CATCHR/A(999),B(999),C(999),D(999),P(999),Q(999),
     1RECON(999),DELVEL(999),DSRDT(999),DELHTS(999),EMAX(999,999),
     2DBLKEN(999),DELHIT(16,999),SOURCE(16,999),SRCTOT(999),
     3HCROLD(16,999),DCDOT(999),HCRUST(16,999),DFILM(16,999),
     4DFMOLD(16,999),DENOLD(999),SIGOX(999),SIGCON(999),BET(999),
     5TFZX(999),TFZC(999),TKX(999),TKM(999),THETO(999,999),
     6THET1(999,999),OMEG0(4,999),OMEG1(4,999),TAO0(999),TAO1(999),
     7SIG0(999),SIG1(999),TARGB(999),DADOT(999),DADOTG(999),
     8XLOLD(4,999),VISREX(999),TATMS(999),HTMP(999),DHTMP(999),
     9HTMOLD(999)
      COMMON/PRINTB/ELEVAT(999),ELOLD(999),XDIST(999,999),XBTW(999,999),
     1TEMP(999,999),ENTHP(999,999),EOLD(999,999),ENBLK(999),EBKOLD(999),
     2TBULK(999),HITE(16,999),HITOLD(16,999),HTOT(999),HTOLD(999),
     3HTCFT(999),HTCOEF(999),QFLUXT(999),QFLUXB(999),VEL(999),ELO(999),
     4VELOLD(999),SRSCOR(16),AREA(999),RAD(999),ARC(999),VOLCN(16),
     5VOID(999),VGJ(999),ZABLAT(999),ZABOLD(999),DCRUST(999),
     6DCROLD(999),DABCON(999),DABOLD(999),DFILMT(999),DFOLT(999),
     7SMFLX(4,999),XLSMF(4,999),TOTVOL,XFACMS(999),XMFLXA,XMCORT,
     8VCORT,TOTOX,TOTMET,QFLXT,QFLXB,TIME,DTIME,XMCOR(16),VCOR(16),
     9TCONI,RSAND,HDOWNC,TBOUND,EMISCN,PDRYWL,XDISTO(999),QOXT(999),
     1XLENSH,XBTWO(999),RCOMP,WDOOR,RSUMP,RSHELL,RPED,TPED,ELSMP,
     1TENDP(10,999),TFRZSH,TDEBRS,TKDEBR,PDEBR,CPDEBR,ENENDP(10,999),
     2ENOLDP(10,999),DXVERT,DXSNK,XDSTE(10,999),XBTE(10,999),HXLA(999),
     3HXLB(999),TSFEB(999),DCRS(999),DCRSLD(999),HCRS(16,999),
     4HCRSLD(16,999),THETE0(10,999),THETE1(10,999),QSHELL,QSHELE,TSHELI,
     5SIGOXE(999),FKOXE(999),RINJC,XLSEC,ANGSEC,ANINJC,XLCHAN,WCHNL,
     6TEFZX(999),TIMSPC(999),DXNODE(999),TNORM(999),FRCSOL(999),
     7ALPSPR(999),CRAMCON,HINTF,TSHLMX,XFRMX(999),XFROX(999),XFRTX(999),
     8XMLMX(999),XMLOX(999),XMLTX(999),XTOTX(999),TIMEO,TMAX,EDOWN(999),
     9HCP(999)
      COMMON/PROPI/ NMATC,NMATFI,NMATFF,ICAOH2,ICACO3,IMCCO3,IFH2O,     
     1IVH2O,ICK2O,IVK2O,INA2O,ITIO2,ISIO2,ICAO,IMGO,IAL2O3,IFEO,IFE2O3, 
     2IFE3O4,IFE,ICR,INI,IZR,IU,IB4C,IB,ICR2O3,INIO,IUO2,IZRO2,IB2O3,   
     3NBCINT(999),NODES(999),NUMNOD,IMOX(28),IBAS,ILCS,ILL,NACTIV(999),     
     4NBFRZM,NBFRZO,NABLFM,NDRNFM,NTYPMT(999,999),NDOOR,NBMADJ,NUMSHV,   
     5NBSHL(999),NCRSTS(999),NUMSHH,NSKIPE,NACSH,NWAT,NPEND,NBCBOT,
     6NCRTOP,NBFZOE,NBFZME,NGEOM,NL(999,999),NFRSCT,NLOGSH,NADAB,NINVIS,
     7NSIMST,NSTEEL,NOVHT,NOVTK,NOVUM,NOVEM,NOVSIG,NPLLOC(999),NBPL,
     8IXP(999),IYP(999),NVTPE,NSOLTP,NSOLF,NINTF,IFLGA(999),ICTYPE,ICTC,
     9NPOURS,NSMP,NPED,NDOR,NSHL,NANULS,NSMPCV,NBOIL,NSWALL,NMVER,
     1NCRTEM,NTHINC,NVELP,NITMAX,NENMAX,NPRINT,NPFREQ,NTIMSPC,NPLFREQ,
     2NPLTOT,NJET,NJETP,NJETD,NJETND,NODCAP,NVELPW,NITMAXW,NENMXW,
     3IFLGJ(999),NBEDCQ,ISHELE
      COMMON/PRINTR/ QFEH2O,QCRH2O,QZRH2O,QFECO2,QCRCO2,QZRCO2,
     4XFH2OU,XFCAOH,XFMGCA,XFCACO,XZRMRE,XFEMRE,XCRMRE,XZRORE,XFEORE,   
     5XCRORE,XMH2O,XMCO2,XMCACO,XMMGCA,XMCAOH,TFWL,TFWS,TBWL,TBWS,      
     6TMCAL,TMCAS,TCAL,TCAS,TFOS,TFOL,TFMS,TFML,XVISC(28),SVISC(28),    
     7XMOL(28),FMMOL(28),ROM(28),ROMLIQ(28),AEQM(28,2),BEQM(28,2),
     8CEQM(28,2),ECL,ECS,ECAL,ECAS,EMCAL,EMCAS,EBWL,EBWS,EFWL,EFWS,    
     9STEF,GRAV,PI,TCS,TCL,CCL,CCS,RMASSL,WPCC,WPM,WPA,WPCS,ROC,RMASSS,   
     1ANGSHL,RSLAGL,RSLAGS,HNODT,VFAV,VGAV,QXAV,XWTSS(16),  
     2TSCS(2),TSCL(2),ESCS(2),ESCL(2),CCSS(2),CCSL(2),ROSTLS,ROSTLL,
     3XFRGAS,HMINC,TST(99),TSTOP(99),AINTP(99),BINTP(99),DRATIO(999),
     4XBCN(999),XDCN(999),XBLT(15),ADEC(99),BDEC(99),APOUR(16,99),
     5BPOUR(16,99),XWTC(14),BWIDTH,THCKCV,TMBOIL,TEBOIL,VFINT,ANGFAN,
     6ALPMAX,THSHL,XFCABL,XNDMIN,DVMX,DAVMX,DEAVMX,DEMX,TDC,QDCU,QDCUO2,
     7TSINJ,EINJ,DTINJ,TKINJ,ROEV,CPINJ,SURFT,VSINJ,EMINJ,TSINJO,EINJO,
     8DTINJO,TKINJO,ROEVO,CPINJO,SURFTO,VSINJO,EMINJO,XLEADE,ARSUM,
     9DBUBOX,UTRISE,TREMSH,DJET,DFALL,WEBER,FROUDE,XPSAITO,XPEPSTN,
     1FRAG,XMBEDT,XMBED(16),XLPENT,XLPENA,UJET,UFALL,HFALL,ERPV,
     2TJETT(99),DJETT(99),HWATP,XDOTJET,DVMXW,DAVMXW,DEMXW,DEAVMXW,
     3QJETW,XSTMJF,TINTSJF,ESAT,DRDOOR,DRANL,EI,QDCBUO2,QDCBU,
     4EBEDS,EBEDB
      COMMON /WATVARS/FCRUST(999),VLW(999),VLWOLD(999),DWAT(999),
     1DWATOLD(999),EWAT(999),EWATOLD(999),TWAT(999),CORDDC(999),
     2DSRDC(999),DHDC(999),TSRDC,TINTDC,HWATB(999),TSURFW(999),XMS(999),
     3XMST,XINTS,ESRDTW(999),TSRDTW(999),DSRDTW(999),TSRDW,TINTDW,
     4TWATI,ELDCO(999),ELDCX(999,99),CRDCX(999,99),TIMINJ(999,99),
     5XDTINJ(999,99),TDTINJ(999,99),ELWATI,XMWAT,XMWATO,XBALW,
     6HDRY(999),EINTW,XMCT(199),XMCDT(16,999),TMPCDT(999),CMPCDT(999),
     7FDC(999),FCOV(999),FBED(999),FHEAT(999),XFACJ(999),
     8XMBEDJ(16,999),XMBEDJT(999),PBED,QBED(999),QWATER(999),
     9QSURFACE(999),QWATERT(999),HBED(999),POROSBED,XMCRDT(16,999),
     1XMCRT(999),XMBDINT(999),XMT(999)
      COMMON/PROPB/CPBM(999),FKB(999,999),DENB(999,999),DTDEB(999,999),
     1EMIBM(999),DENCRS(999),ENCRS(999),FKRF(999),DENRF(999),CPRF(999) 
      COMMON/PROPM/DTDEM(999),CPMLT(999),FKMLT(999),DENMLT(999),
     1SIGMLT(999),UMMLT(999),EMIMLT(999)      
      COMMON/BASPR/ HBMT(999,999,16),HBMOLD(999,999,16)
      DATA TREF /298.15/
      DATA HMINCQ/0.005/
C...................................................................... 
C.....FIRST CALCULATE OXIDATION ENERGY FLUX IN MELT. 
      DO 6044 KDR=1,NUMNOD      
      IF(NADAB.EQ.1.OR.NACTIV(KDR).EQ.0) GO TO 6045
      IF(HTOT(KDR).LE.0.D0) GO TO 6045
      IF(HITE(1,KDR).LE.0.D0) GO TO 6038  
      CALL INDEX(1,IPRS)
      GZH2O=(FMMOL(IPRS)*QZRH2O)/XZRMRE   
      GZCO2=(FMMOL(IPRS)*QZRCO2)/XZRMRE   
      GO TO 6039      
 6038 CONTINUE
      GZH2O=0.D0      
      GZCO2=0.D0      
 6039 CONTINUE
      IF(HITE(2,KDR).LE.0.D0) GO TO 6040  
      IF(HITE(1,KDR).GT.0.D0) GO TO 6040  
      IF(HITE(3,KDR).GT.0.D0) GO TO 6040  
      CALL INDEX(2,IPRS)
      GFH2O=(FMMOL(IPRS)*QFEH2O)/XFEMRE   
      GFCO2=0.D0      
      GO TO 6041      
 6040 CONTINUE
      GFH2O=0.D0      
      GFCO2=0.D0      
 6041 CONTINUE
      IF(HITE(3,KDR).LE.0.D0) GO TO 6042  
      IF(HITE(1,KDR).GT.0.D0) GO TO 6042  
      CALL INDEX(3,IPRS)
      GCH2O=(FMMOL(IPRS)*QCRH2O)/XCRMRE   
      GCCO2=(FMMOL(IPRS)*QCRCO2)/XCRMRE   
      GO TO 6043      
 6042 CONTINUE
      GCH2O=0.D0      
      GCCO2=0.D0      
 6043 CONTINUE
      TSEND=TEMP(1,KDR)
      IF(TSEND.GT.TCS) TSEND=TCS
      DBSEND=DMIN1(HTOT(KDR),DBUBOX)      
      DBSEND=DMAX1(HMINC,DBSEND)
      CALL OXID(PDRYWL,TSEND,TBULK(KDR),DBSEND,HTOT(KDR),UTRISE,OXH2O,OX
     1CO2)  
      TILH2O=(OXH2O*(GZH2O+GFH2O+GCH2O))/XMH2O      
      TILCO2=(OXCO2*(GZCO2+GFCO2+GCCO2))/XMCO2      
      QOXT(KDR)=TILH2O*(SMFLX(1,KDR)+SMFLX(2,KDR))+TILCO2*(SMFLX(3,KDR)+
     1SMFLX(4,KDR))   
      GO TO 6044      
 6045 CONTINUE
      QOXT(KDR)=0.D0  
 6044 CONTINUE
C...................................................................... 
C.....CALCULATE MELT-TO-BASEMAT AND MELT-TO-WATER OR ATMOSPHERE HEAT    
C.....FLUXES.
      SUMT=0.D0
      SUMA=0.D0
      SUMB=0.D0
      SUMF=0.D0
      SUMJG=0.D0      
      SUMVF=0.D0      
      SUMOX=0.D0      
      DO 4960 KN=1,NUMNOD
      IF(NACTIV(KN).EQ.0.OR.NADAB.EQ.1) GO TO 4960      
      IF(HTOT(KN).GT.0.D0) GO TO 4961     
      QFLUXT(KN)=0.D0 
      QFLUXB(KN)=0.D0 
      GO TO 4960      
 4961 CONTINUE
C.....ASSIGN BASEMAT SURFACE TEMPERATURE. 
      GO TO(61,62,62,63,63,62,62,62,62),NBCINT(KN)  
   61 CONTINUE
      TEVAL=TEMP(1,KN)
      GO TO 65
   62 CONTINUE
      TEVAL=TFZX(KN)  
      GO TO 65
   63 CONTINUE
      TEVAL=TFZC(KN)  
   65 CONTINUE
      SUMA=SUMA+AREA(KN)
      HEFFW=FCRUST(KN)*HTCFT(KN)
      IF(NWAT.EQ.2) HEFFW=DMAX1(HEFFW,HDRY(KN))
      QFLUXT(KN)=HEFFW*(TBULK(KN)-TATMS(KN))    
      QFLUXB(KN)=HTCOEF(KN)*(TBULK(KN)-TEVAL)
      SUMB=SUMB+QFLUXB(KN)*AREA(KN)
      SUMT=SUMT+QFLUXT(KN)*AREA(KN)
      SUMF=SUMF+(SMFLX(1,KN)+SMFLX(2,KN)+SMFLX(3,KN)+SMFLX(4,KN))*AREA(K
     1N)    
      SUMJG=SUMJG+VGJ(KN)*AREA(KN)
      SUMVF=SUMVF+VOID(KN)*AREA(KN)
      SUMOX=SUMOX+QOXT(KN)*AREA(KN)
 4960 CONTINUE
      IF(SUMA.GT.0.D0) GO TO 4962
      QFLXT=0.D0      
      QFLXB=0.D0      
      XMFLXA=0.D0     
      VFAV=0.D0
      VGAV=0.D0
      QXAV=0.D0
      GO TO 4963      
 4962 CONTINUE
      QFLXT=SUMT/SUMA 
      QFLXB=SUMB/SUMA 
      XMFLXA=SUMF/SUMA
      VFAV=SUMVF/SUMA 
      VGAV=SUMJG/SUMA 
      QXAV=SUMOX/SUMA 
 4963 CONTINUE 
C......................................................................
C.....NOW CALCULATE MELT AND SOLIDFIED DEBRIS MASS DISRIBUTION 
C.....FUNCTIONS.  THIS INCLUDES UPDATING OF FUNCTIONS THAT ARE USED 
C.....TO DEFINE INPUT TO CORQUENCH.
      DO 7201 KH=1,NUMNOD
      XFRMX(KH)=0.D0
      XFROX(KH)=0.D0
      XFRTX(KH)=0.D0
      XMLMX(KH)=0.D0
      XMLOX(KH)=0.D0
      XMLTX(KH)=0.D0
      XTOTX(KH)=0.D0
      XMCT(KH)=0.D0
      XMT(KH)=0.E0
      XMCRT(KH)=0.D0
      DO 7199 KT=1,16
      XMCDT(KT,KH)=0.D0
      XMCRDT(KT,KH)=0.D0
 7199 CONTINUE
 7201 CONTINUE
      DO 7202 KH=1,NUMNOD
C.....NOW DETERMINE THE MASS DISTRIBUTION FUNCTIONS...
      SUMMM=0.D0
      SUMOM=0.D0
      SUMMF=0.D0
      SUMOF=0.D0
      IF(NACTIV(KH).EQ.0.OR.NADAB.EQ.1) GO TO 7206
      DO 7203 KTP=1,16
      CALL INDEX(KTP,KJ)
      RFAC=ROMLIQ(KJ)   
      IF(KTP.EQ.16) RFAC=ROC*RSLAGL    
      RFACS=ROM(KJ)
      IF(KTP.EQ.16) RFACS=ROC*RSLAGS
      XINCM=RFAC*HITE(KTP,KH)*AREA(KH)*FLOAT(NDOOR)   
      XINCF=0.D0
      DO 7204 KV=1,NODES(KH)
      IF(NTYPMT(KV,KH).LE.3) GO TO 7204
      XINCF=XINCF+RFACS*HBMT(KV,KH,KTP)*AREA(KH)*FLOAT(NDOOR)   
 7204 CONTINUE   
C.....ADD MELT, FROZEN DEBRIS, AND BED MASSES AS APPROPRIATE
C.....TO GET TOTAL MASS AT NODE SITE
      XMCDT(KTP,KH)=XINCF+XINCM
      XMCT(KH)=XMCT(KH)+XMCDT(KTP,KH)
      XMT(KH)=XMCT(KH)
      IF(KTP.GE.8) GO TO 7205
      SUMMM=SUMMM+XINCM
      SUMMF=SUMMF+XINCF
      GO TO 7203
 7205 CONTINUE
      SUMOM=SUMOM+XINCM
      SUMOF=SUMOF+XINCF
 7203 CONTINUE
      IF(KH.GT.1) GO TO 7206 
      XMLMX(KH)=SUMMM
      XFRMX(KH)=SUMMF
      XMLOX(KH)=SUMOM
      XFROX(KH)=SUMOF
      GO TO 7207
 7206 CONTINUE
      XMLMX(KH)=XMLMX(KH-1)+SUMMM
      XFRMX(KH)=XFRMX(KH-1)+SUMMF
      XMLOX(KH)=XMLOX(KH-1)+SUMOM
      XFROX(KH)=XFROX(KH-1)+SUMOF
 7207 CONTINUE
      XMLTX(KH)=XMLMX(KH)+XMLOX(KH)
      XFRTX(KH)=XFRMX(KH)+XFROX(KH)+XMBDINT(KH)
      XTOTX(KH)=XMLTX(KH)+XFRTX(KH)
      IF(NACTIV(KH).EQ.0.OR.NADAB.EQ.1) GO TO 7202
      IF(IFINISH.EQ.0) GO TO 7202
C.....AT THE END OF THE RUN, CALCULATE DATA NEEDED TO PREPARE AN INPUT
C.....FILE FOR A FOLLOW-ON CORQUENCH CALCULATION.  FIRST CALCULATE THE
C.....THERMAL EQUILIBRIUM TEMPERATURE OF CORE DEBRIS AT THE NODE SITES
C.....DEPENDING UPON MODELING ASSUMPTIONS.
      ENMLT=0.D0
      IF(HTOT(KH).GT.0.D0) ENMLT=DENMLT(KH)*HTOT(KH)*AREA(KH)*ENBLK(KH)
      ENTHEV=0.D0
      IF(XMBEDT.LE.0.D0) GO TO 4762
      IF(NBEDCQ.EQ.0) GO TO 4762
      ENTHEV=EBEDS
      IF(DWAT(KH).LE.0.D0) ENTHEV=EBEDB
      IF(NJET.EQ.2.AND.NBEDCQ.EQ.1) ENBED=XMBEDJT(KH)*ENTHEV
 4762 CONTINUE
      ENFRZ=0.D0
      DO 7198 KV=1,NODES(KH)
      IF(NTYPMT(KV,KH).LE.3) GO TO 7198
      XLNGTH=XDIST(KV,KH)
      IF(KV.EQ.1.AND.NBCINT(KH).GT.3) XLNGTH=ZABLAT(KH) 
      ENFRZ=ENFRZ+DENB(KV,KH)*XLNGTH*AREA(KH)*FLOAT(NDOOR)*ENTHP(KV,KH)
 7198 CONTINUE
      ENHOMOG=0.D0
      XMHOMOG=XMCT(KH)
      IF(NBEDCQ.EQ.0.OR.NJET.LT.2) GO TO 9781
      XMHOMOG=XMHOMOG+XMBEDJT(KH)
 9781 CONTINUE
      IF(XMHOMOG.GT.0.D0) ENHOMOG=(ENMLT+ENBED+ENFRZ)/XMHOMOG
C.....NOW SEE IF THERE IS A PARTICLE BED AND IF IT IS TO BE RETAINED AS 
C.....A SEPARATE ELEMENT.  IF NOT, RECOMBINE THE PARTICLE BED WITH 
C.....THE UNDERLYING DEBRIS BEFORE CALCULATING THE RESULTANT DEBRIS
C.....EQUILIBRIUM TEMPERATURE.
      IF(NBEDCQ.EQ.0.OR.NJET.LT.2) GO TO 8178
      DO 9199 KT=1,16
      XMCDT(KT,KH)=XMCDT(KT,KH)+XMBEDJ(KT,KH)
      XMCT(KH)=XMCT(KH)+XMBEDJ(KTP,KH)
      XMT(KH)=XMCT(KH)
      XMBEDJ(KT,KH)=0.D0
 9199 CONTINUE
 8178 CONTINUE
C.....NOW GET CORE DEBRIS THERMAL EQUILIBRIUM TEMPERATURE DEPENDING
C.....UPON FINAL MELT CONSTITUENCY. 
      DO 4536 KTP=1,28
      HSEND(KTP)=0.D0 
 4536 CONTINUE
      VTOT=0.D0
      VMET=0.D0
      DO 4538 KTP=1,15
      CALL INDEX(KTP,KJ)
      HSEND(KJ)=XMCDT(KTP,KH)/ROMLIQ(KJ)
      VTOT=VTOT+HSEND(KJ)
      IF(KTP.LE.7) VMET=VMET+HSEND(KJ)
 4538 CONTINUE
      HSEND(10)=(WPCS*XMCDT(16,KH))/ROMLIQ(ISIO2)
      HSEND(11)=(WPCC*XMCDT(16,KH))/ROMLIQ(ICAO)    
      HSEND(12)=(WPM*XMCDT(16,KH))/ROMLIQ(IMGO)     
      HSEND(13)=(WPA*XMCDT(16,KH))/ROMLIQ(IAL2O3)   
      VTOT=VTOT+HSEND(10)+HSEND(11)+HSEND(12)+HSEND(13)
      CALL TEF(ENHOMOG,HSEND,TMPCDT(KH),DTDE)    
      CMPCDT(KH)=1.D0/DTDE
C.....NOW, IF PARTICLE BED IS TO BE RETAINED AS PART OF CORQUENCH INPUT, 
C.....SPLIT THE CORE DEBRIS LAYER INTO 'MELT' AND 'CRUST' ZONES WHERE BED
C.....EXISTS.  OTHERWISE, CORQUENCH WILL PUT THE BED BACK INTO THE MELT IF 
C.....THERE IS NO CRUST...
      IF(NJET.LE.1.OR.NBEDCQ.EQ.1) GO TO 7202
      IF(XMBEDJT(KH).LE.0.D0) GO TO 7202
      DENMCT=XMCT(KH)/VTOT
      CALL CONDF(TMPCDT(KH),HSEND,FKO,FKM,FKMCT)   
      TFRZ=TFOS
      IF(VMET/VTOT.GT.0.5) TFRZ=TFMS
      CALL CONWAT(TSAT,KL,PL,CL,UL,HLV,EWL,EWV,CWV,SIGMA,PDRYWL)
      TOUTER=TSAT
      IF(DWAT(KH).LE.0.D0) TOUTER=TBOUND
      QHFLUXEV=HTCFT(KH)*(TBULK(KH)-TATMS(KH))
      IF(HTOT(KH).GT.0.D0) GO TO 4788
      TOUTER=TBOUND
      QHFLUXEV=HTCOEF(KH)*(TSURFW(KH)-TARGB(KH))
 4788 CONTINUE   
      DCRST=0.D0
      IF(QHFLUXEV.GT.0.D0) DCRST=(FKMCT*(TFRZ-TOUTER))/QHFLUXEV
      XMCRUST=DENMCT*AREA(KH)*DCRST
      XMMELT=XMCT(KH)-XMCRUST
      XMELTMN=DENMCT*HMINCQ*AREA(KH)
      IF(XMMELT.GE.XMELTMN) GO TO 8203
      XMMELT=XMELTMN
      XMCRUST=XMCT(KH)-XMMELT
 8203 CONTINUE
      DO 8199 KT=1,16
      FACTOR=XMCDT(KT,KH)/XMCT(KH)
      XMCRDT(KT,KH)=FACTOR*XMCRUST
      XMCDT(KT,KH)=FACTOR*XMMELT
 8199 CONTINUE
      XMCRT(KH)=XMCRUST
      XMCT(KH)=XMMELT
 7202 CONTINUE
      RETURN
      END