C...................................................................... 
C.....GIVEN THE VELOCITIES, HEIGHT INCREMENTS, AND CONCRETE FORWARD     
C.....ELIMINATION COEFFICIENTS, SUBROUTINE ENERELM SOLVES FOR THE BULK 
C.....MELT SPECIFIC ENTHALPY INCRMENTS.     
C...................................................................... 
      SUBROUTINE ENERELM
      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
      COMMON/CATCHR/A(999),B(999),C(999),D(999),P(999),Q(999),
     1RECON(999),DELVEL(999),DSRDT(999),DELHTS(999),EMAX(999,999),
     2DBLKEN(999),DELHIT(16,999),SOURCE(16,999),SRCTOT(999),
     3HCROLD(16,999),DCDOT(999),HCRUST(16,999),DFILM(16,999),
     4DFMOLD(16,999),DENOLD(999),SIGOX(999),SIGCON(999),BET(999),
     5TFZX(999),TFZC(999),TKX(999),TKM(999),THETO(999,999),
     6THET1(999,999),OMEG0(4,999),OMEG1(4,999),TAO0(999),TAO1(999),
     7SIG0(999),SIG1(999),TARGB(999),DADOT(999),DADOTG(999),
     8XLOLD(4,999),VISREX(999),TATMS(999),HTMP(999),DHTMP(999),
     9HTMOLD(999)
      COMMON/CATCHI/NUMS(4,999),NUMOLD(4,999),NTRACK(16),NSUMP(999),
     1NPASSG(999),NCRSTM(999),NCRRT(999),NPASS(999),NBURN,NBURNO     
      COMMON/PRINTB/ELEVAT(999),ELOLD(999),XDIST(999,999),XBTW(999,999),
     1TEMP(999,999),ENTHP(999,999),EOLD(999,999),ENBLK(999),EBKOLD(999),
     2TBULK(999),HITE(16,999),HITOLD(16,999),HTOT(999),HTOLD(999),
     3HTCFT(999),HTCOEF(999),QFLUXT(999),QFLUXB(999),VEL(999),ELO(999),
     4VELOLD(999),SRSCOR(16),AREA(999),RAD(999),ARC(999),VOLCN(16),
     5VOID(999),VGJ(999),ZABLAT(999),ZABOLD(999),DCRUST(999),
     6DCROLD(999),DABCON(999),DABOLD(999),DFILMT(999),DFOLT(999),
     7SMFLX(4,999),XLSMF(4,999),TOTVOL,XFACMS(999),XMFLXA,XMCORT,
     8VCORT,TOTOX,TOTMET,QFLXT,QFLXB,TIME,DTIME,XMCOR(16),VCOR(16),
     9TCONI,RSAND,HDOWNC,TBOUND,EMISCN,PDRYWL,XDISTO(999),QOXT(999),
     1XLENSH,XBTWO(999),RCOMP,WDOOR,RSUMP,RSHELL,RPED,TPED,ELSMP,
     1TENDP(10,999),TFRZSH,TDEBRS,TKDEBR,PDEBR,CPDEBR,ENENDP(10,999),
     2ENOLDP(10,999),DXVERT,DXSNK,XDSTE(10,999),XBTE(10,999),HXLA(999),
     3HXLB(999),TSFEB(999),DCRS(999),DCRSLD(999),HCRS(16,999),
     4HCRSLD(16,999),THETE0(10,999),THETE1(10,999),QSHELL,QSHELE,TSHELI,
     5SIGOXE(999),FKOXE(999),RINJC,XLSEC,ANGSEC,ANINJC,XLCHAN,WCHNL,
     6TEFZX(999),TIMSPC(999),DXNODE(999),TNORM(999),FRCSOL(999),
     7ALPSPR(999),CRAMCON,HINTF,TSHLMX,XFRMX(999),XFROX(999),XFRTX(999),
     8XMLMX(999),XMLOX(999),XMLTX(999),XTOTX(999),TIMEO,TMAX,EDOWN(999),
     9HCP(999)
      COMMON/HCONS/HMETAL(999),HOXIDE(999)  
      COMMON/PROPI/ NMATC,NMATFI,NMATFF,ICAOH2,ICACO3,IMCCO3,IFH2O,     
     1IVH2O,ICK2O,IVK2O,INA2O,ITIO2,ISIO2,ICAO,IMGO,IAL2O3,IFEO,IFE2O3, 
     2IFE3O4,IFE,ICR,INI,IZR,IU,IB4C,IB,ICR2O3,INIO,IUO2,IZRO2,IB2O3,   
     3NBCINT(999),NODES(999),NUMNOD,IMOX(28),IBAS,ILCS,ILL,NACTIV(999),     
     4NBFRZM,NBFRZO,NABLFM,NDRNFM,NTYPMT(999,999),NDOOR,NBMADJ,NUMSHV,   
     5NBSHL(999),NCRSTS(999),NUMSHH,NSKIPE,NACSH,NWAT,NPEND,NBCBOT,
     6NCRTOP,NBFZOE,NBFZME,NGEOM,NL(999,999),NFRSCT,NLOGSH,NADAB,NINVIS,
     7NSIMST,NSTEEL,NOVHT,NOVTK,NOVUM,NOVEM,NOVSIG,NPLLOC(999),NBPL,
     8IXP(999),IYP(999),NVTPE,NSOLTP,NSOLF,NINTF,IFLGA(999),ICTYPE,ICTC,
     9NPOURS,NSMP,NPED,NDOR,NSHL,NANULS,NSMPCV,NBOIL,NSWALL,NMVER,
     1NCRTEM,NTHINC,NVELP,NITMAX,NENMAX,NPRINT,NPFREQ,NTIMSPC,NPLFREQ,
     2NPLTOT,NJET,NJETP,NJETD,NJETND,NODCAP,NVELPW,NITMAXW,NENMXW,
     3IFLGJ(999),NBEDCQ,ISHELE
      COMMON/DATOVER/COVS,COVL,DHSOV,XMOLOV,ROVS,ROVL,TKOVS,TKOVL,VISOV,
     1EMOV,SIGOV
      COMMON/PRINTR/ QFEH2O,QCRH2O,QZRH2O,QFECO2,QCRCO2,QZRCO2,
     4XFH2OU,XFCAOH,XFMGCA,XFCACO,XZRMRE,XFEMRE,XCRMRE,XZRORE,XFEORE,   
     5XCRORE,XMH2O,XMCO2,XMCACO,XMMGCA,XMCAOH,TFWL,TFWS,TBWL,TBWS,      
     6TMCAL,TMCAS,TCAL,TCAS,TFOS,TFOL,TFMS,TFML,XVISC(28),SVISC(28),    
     7XMOL(28),FMMOL(28),ROM(28),ROMLIQ(28),AEQM(28,2),BEQM(28,2),
     8CEQM(28,2),ECL,ECS,ECAL,ECAS,EMCAL,EMCAS,EBWL,EBWS,EFWL,EFWS,    
     9STEF,GRAV,PI,TCS,TCL,CCL,CCS,RMASSL,WPCC,WPM,WPA,WPCS,ROC,RMASSS,   
     1ANGSHL,RSLAGL,RSLAGS,HNODT,VFAV,VGAV,QXAV,XWTSS(16),  
     2TSCS(2),TSCL(2),ESCS(2),ESCL(2),CCSS(2),CCSL(2),ROSTLS,ROSTLL,
     3XFRGAS,HMINC,TST(99),TSTOP(99),AINTP(99),BINTP(99),DRATIO(999),
     4XBCN(999),XDCN(999),XBLT(15),ADEC(99),BDEC(99),APOUR(16,99),
     5BPOUR(16,99),XWTC(14),BWIDTH,THCKCV,TMBOIL,TEBOIL,VFINT,ANGFAN,
     6ALPMAX,THSHL,XFCABL,XNDMIN,DVMX,DAVMX,DEAVMX,DEMX,TDC,QDCU,QDCUO2,
     7TSINJ,EINJ,DTINJ,TKINJ,ROEV,CPINJ,SURFT,VSINJ,EMINJ,TSINJO,EINJO,
     8DTINJO,TKINJO,ROEVO,CPINJO,SURFTO,VSINJO,EMINJO,XLEADE,ARSUM,
     9DBUBOX,UTRISE,TREMSH,DJET,DFALL,WEBER,FROUDE,XPSAITO,XPEPSTN,
     1FRAG,XMBEDT,XMBED(16),XLPENT,XLPENA,UJET,UFALL,HFALL,ERPV,
     2TJETT(99),DJETT(99),HWATP,XDOTJET,DVMXW,DAVMXW,DEMXW,DEAVMXW,
     3QJETW,XSTMJF,TINTSJF,ESAT,DRDOOR,DRANL,EI,QDCBUO2,QDCBU,
     4EBEDS,EBEDB
      COMMON /WATVARS/FCRUST(999),VLW(999),VLWOLD(999),DWAT(999),
     1DWATOLD(999),EWAT(999),EWATOLD(999),TWAT(999),CORDDC(999),
     2DSRDC(999),DHDC(999),TSRDC,TINTDC,HWATB(999),TSURFW(999),XMS(999),
     3XMST,XINTS,ESRDTW(999),TSRDTW(999),DSRDTW(999),TSRDW,TINTDW,
     4TWATI,ELDCO(999),ELDCX(999,99),CRDCX(999,99),TIMINJ(999,99),
     5XDTINJ(999,99),TDTINJ(999,99),ELWATI,XMWAT,XMWATO,XBALW,
     6HDRY(999),EINTW,XMCT(199),XMCDT(16,999),TMPCDT(999),CMPCDT(999),
     7FDC(999),FCOV(999),FBED(999),FHEAT(999),XFACJ(999),
     8XMBEDJ(16,999),XMBEDJT(999),PBED,QBED(999),QWATER(999),
     9QSURFACE(999),QWATERT(999),HBED(999),POROSBED,XMCRDT(16,999),
     1XMCRT(999),XMBDINT(999),XMT(999)
      COMMON/BLKHT/TKMLT,PM,CM,UM,EMISM,SIGMAM,TKNC,PNC,CNC,UNC    
      COMMON/BASPR/ HBMT(999,999,16),HBMOLD(999,999,16) 
      COMMON/DATSH/TSTLS,TSTLL,ESTLS,ESTLL,DFUSST,CSTLL
      COMMON/DATSIMS/TSIS,TSIL,CSIS,CSIL,DHSIL,RSIS,RSIL,TKSIS,TKSIL,
     1ESIL,XCSI(16)
      COMMON/DEFUNC/CPLIQP,CPSOLP,EFOSP,EFOLP,EFMSP,EFMLP     
      COMMON/PROPB/CPBM(999),FKB(999,999),DENB(999,999),DTDEB(999,999),
     1EMIBM(999),DENCRS(999),ENCRS(999),FKRF(999),DENRF(999),CPRF(999) 
      COMMON/PROPM/DTDEM(999),CPMLT(999),FKMLT(999),DENMLT(999),
     1SIGMLT(999),UMMLT(999),EMIMLT(999)      
C.....FIRST UPDATE MELT DENSITIES FOR USE IN SOLVING THE CONSERVATION 
C.....OF ENERGY EQUATION, AND ZERO OUT BULK ENTHALY INCREMENT FROM 
c.....PREVIOUS TIMESTEP.
      DO 5735 J=1,NUMNOD
      IF(NACTIV(J).EQ.0) GO TO 5735
      DBLKEN(J)=0.D0
      IF(HTOT(J).LE.0.D0) GO TO 5735
      CALL MASFRA(HITE,ROMLIQ,J,RSLAGL,ROC,DENMLT(J),0)
 5735 CONTINUE
      JSEND=1
      PHJ=0.D0
      PHEJ=0.D0
      IF(NACTIV(JSEND).EQ.0) GO TO 5049
      IF(HTOT(JSEND).LE.0.D0) GO TO 5049
      ROCJP1=DENMLT(JSEND)      
      PHJP1=ROCJP1*HTOT(JSEND)  
      PHEJP1=ROCJP1*HTOT(JSEND)*ENBLK(JSEND)
      GO TO 5050      
 5049 CONTINUE
      PHJP1=0.D0      
      PHEJP1=0.D0     
 5050 CONTINUE
      DO 5036 KDR=1,NUMNOD      
      IF(NADAB.EQ.1) GO TO 6062
      KSEND=KDR+1     
      IF(KDR.EQ.NUMNOD) GO TO 5051
      IF(NACTIV(KSEND).EQ.0) GO TO 5051
      IF(HTOT(KSEND).LE.0.D0) GO TO 5051
      PHJM1=PHJ
      PHEJM1=PHEJ     
      PHJ=PHJP1
      PHEJ=PHEJP1     
      ROCJP1=DENMLT(KSEND)      
      PHJP1=ROCJP1*HTOT(KSEND)  
      PHEJP1=ROCJP1*HTOT(KSEND)*ENBLK(KSEND)
      GO TO 5052      
 5051 CONTINUE
      PHJM1=PHJ
      PHEJM1=PHEJ     
      PHJ=PHJP1
      PHEJ=PHEJP1     
      PHJP1=0.D0      
      PHEJP1=0.D0     
 5052 CONTINUE
      IF(NACTIV(KDR).EQ.0) GO TO 6062
      IF(HTOT(KDR).GT.0.D0) GO TO 5037   
 6062 CONTINUE
      A(KDR)=1.D0
      B(KDR)=0.D0     
      C(KDR)=0.D0     
      D(KDR)=0.D0     
      GO TO 5036      
 5037 CONTINUE
      HFRZL=HMINC
      PHJM=DENMLT(KDR)*DMAX1(HFRZL,HTOT(KDR))
C.....CALCULATE OXIDATION COEFFICIENTS FOR ZIRCONIUM, IRON, & CHROMIUM  
C.....LAYERS.
      IF(HITE(1,KDR).LE.0.D0) GO TO 5038  
      CALL INDEX(1,IPRS)
      GZH2O=(FMMOL(IPRS)*QZRH2O)/XZRMRE   
      GZCO2=(FMMOL(IPRS)*QZRCO2)/XZRMRE   
      GO TO 5039      
 5038 CONTINUE
      GZH2O=0.D0      
      GZCO2=0.D0      
 5039 CONTINUE
      IF(HITE(2,KDR).LE.0.D0) GO TO 5040  
      IF(HITE(1,KDR).GT.0.D0) GO TO 5040  
      IF(HITE(3,KDR).GT.0.D0) GO TO 5040  
      CALL INDEX(2,IPRS)
      GFH2O=(FMMOL(IPRS)*QFEH2O)/XFEMRE   
      GFCO2=0.D0      
      GO TO 5041      
 5040 CONTINUE
      GFH2O=0.D0      
      GFCO2=0.D0      
 5041 CONTINUE
      IF(HITE(3,KDR).LE.0.D0) GO TO 5042  
      IF(HITE(1,KDR).GT.0.D0) GO TO 5042  
      CALL INDEX(3,IPRS)
      GCH2O=(FMMOL(IPRS)*QCRH2O)/XCRMRE   
      GCCO2=(FMMOL(IPRS)*QCRCO2)/XCRMRE   
      GO TO 5043      
 5042 CONTINUE
      GCH2O=0.D0      
      GCCO2=0.D0      
 5043 CONTINUE
      TSEND=TEMP(1,KDR)
      IF(TSEND.GT.TCS) TSEND=TCS
      DBSEND=DMIN1(HTOT(KDR),DBUBOX)      
      DBSEND=DMAX1(HMINC,DBSEND)
      CALL OXID(PDRYWL,TSEND,TBULK(KDR),DBSEND,HTOT(KDR),UTRISE,OXH2O,OX
     1CO2)  
      TILH2O=(AREA(KDR)*OXH2O*(GZH2O+GFH2O+GCH2O))/XMH2O      
      TILCO2=(AREA(KDR)*OXCO2*(GZCO2+GFCO2+GCCO2))/XMCO2      
C.....CALCULATE ABLATION & CRUSTING COEFFICIENTS FOR THE PRESENT NODE.  
C.....FIRST CALCULATE THE CRUSTING COEFFICIENT.     
      IF(NBCINT(KDR).EQ.2.AND.NCRRT(KDR).EQ.1) GO TO 5044     
      IF(NBCINT(KDR).EQ.6.AND.NCRRT(KDR).EQ.1) GO TO 5044     
      IF(NBCINT(KDR).EQ.8.AND.NCRRT(KDR).EQ.1) GO TO 5044     
      ZLAMCR=0.D0     
      GO TO 5045      
 5044 CONTINUE
      ZLAMCR=DENCRS(KDR)*ENCRS(KDR)
 5045 CONTINUE
C.....CALCULATE ABLATION COEFFICIENT.     
      IF(NBCINT(KDR).GT.3) GO TO 3019     
      IP=1  
      ZLAMAB=0.D0     
      GO TO 5047      
 3019 CONTINUE
      ZCOMP=XDISTO(KDR)-ZABLAT(KDR)
      IP=2  
      IF(ZCOMP.LT.XBTWO(KDR)) IP=1
      IF(NBCINT(KDR).EQ.4) GO TO 5046     
      IF(NBCINT(KDR).EQ.6) GO TO 5046     
      IF(NBCINT(KDR).EQ.7) GO TO 5046     
      ZLAMAB=0.D0     
      GO TO 5047      
 5046 CONTINUE
      ZLAMAB=DENB(IP,KDR)*ENTHP(IP,KDR)   
 5047 CONTINUE
C.....EVALUATE DECAY HEAT TERMS.
      PQDECJ=ROMLIQ(21)*QDCU*HITE(6,KDR)+ROMLIQ(26)*QDCUO2*HITE(15,KDR) 
C.....EVALUATE ENERGY SOURCE DUE TO INJECTION FROM RPV AT THIS NODE.    
      QSRC=SRCTOT(KDR)*EINJ     
C.....EVALUATE OLD TIMESTEP DENSITY & SPECIFIC HEAT.
      IF(HTOLD(KDR).LE.0.D0) GO TO 5057   
      PHEOLD=EBKOLD(KDR)*DENOLD(KDR)*HTOLD(KDR)
      GO TO 5058      
 5057 CONTINUE
      PHEOLD=0.D0     
 5058 CONTINUE
C.....ASSIGN VALUES FOR TDMA COEFFICIENT EVALUATION.
      VJM12=VEL(KDR)  
      VJP12=VEL(KDR+1)
      IF(KDR.EQ.1) GO TO 5053   
      IF(KDR.EQ.NUMNOD) GO TO 5054
      HJM1=HTOT(KDR-1)
      HJP1=HTOT(KDR+1)
      GO TO 5055      
 5053 CONTINUE
      HJM1=0.D0
      HJP1=HTOT(KDR+1)
      GO TO 5055      
 5054 CONTINUE
      HJM1=HTOT(KDR-1)
      HJP1=0.D0
 5055 CONTINUE
      HJ=HTOT(KDR)    
C.....EVALUATE DERIVATIVE OF BULK TEMPERATURE WITH RESPECT TO ENTHALPY, 
C.....AND CACULATE ITERATIVE BULK ENTHALPY CAP.     
      ALPBLK=DTDEM(KDR)
C.....EVALUATE TDMA COEFFICIENTS.
      HC1=(AREA(KDR)*(PHEJ-PHEOLD))/DTIME 
      HC2=ARC(KDR)*DMAX1(VJM12,0.D0)*PHEJM1
      HC3=PHEJ*(ARC(KDR)*DMAX1(-VJM12,0.D0)+ARC(KDR+1)*DMAX1(VJP12,0.D0)
     1)     
      HC4=ARC(KDR+1)*DMAX1(-VJP12,0.D0)*PHEJP1      
      ALP1J=DTDEB(1,KDR)
      IF(NBCINT(KDR).GT.1) GO TO 361      
      TEVAL=TEMP(1,KDR)
      GO TO 362
  361 CONTINUE
      IF(NBCINT(KDR).EQ.4) GO TO 363      
      IF(NBCINT(KDR).EQ.5) GO TO 364      
      TEVAL=TFZX(KDR) 
      GO TO 362
  363 CONTINUE
      TEVAL=TFZC(KDR) 
      GO TO 362
  364 CONTINUE
      TEVAL=(HTCOEF(KDR)*TBULK(KDR)+TKM(KDR)*TEMP(1,KDR)/DFILMT(KDR))/  
     1(HTCOEF(KDR)+TKM(KDR)/DFILMT(KDR))  
  362 CONTINUE
      QC=0.D0
      QCE=0.D0
      IF(NACSH.EQ.0) GO TO 6894 
      IF(KDR.NE.NBMADJ) GO TO 6894
      QC=QSHELL
      QCE=QSHELE      
 6894 CONTINUE
      ZX=1.D0
      IF(NSWALL.EQ.0) GO TO 3816
      GO TO(3817,3816),NGEOM    
 3817 CONTINUE
      IF(KDR.GT.NSMP+NPED.AND.KDR.LE.NSMP+NPED+NDOR) ZX=1.D0+(2.D0*DRDOO
     1R*HTOT(KDR))/AREA(KDR)    
      IF(KDR.GT.NSMP+NPED+NDOR+NSHL) ZX=1.D0+(4.D0*DRANL*HTOT(KDR))/AREA
     1(KDR) 
 3816 CONTINUE
      HTWEF=FCRUST(KDR)*HTCFT(KDR)
      IF(NWAT.EQ.2) HTWEF=DMAX1(HTWEF,HDRY(KDR))
      HC5=AREA(KDR)*ZX*HTCOEF(KDR)*(TBULK(KDR)-TEVAL-ALP1J*THETO(1,KDR))
     1+HTWEF*(TBULK(KDR)-TATMS(KDR))*AREA(KDR)+ARC(KDR+1)*QC
      HC6=ZLAMAB*(DADOT(KDR)+TAO0(KDR))*AREA(KDR)   
      HC7=ZLAMCR*(DCDOT(KDR)+SIG0(KDR))*AREA(KDR)   
      HC8=TILCO2*(SMFLX(3,KDR)+SMFLX(4,KDR)+OMEG0(3,KDR)+OMEG0(4,KDR))+ 
     1TILH2O*(SMFLX(1,KDR)+SMFLX(2,KDR)+OMEG0(1,KDR)+OMEG0(2,KDR))      
      HC9=AREA(KDR)*(PQDECJ+QSRC)
      HCJ=HC1-HC2+HC3-HC4+HC5+HC6+HC7-HC8-HC9
      EC1=PHJM*AREA(KDR)/DTIME+PHJ*(ARC(KDR)*DMAX1(-VJM12,0.D0)+ARC(KD
     1R+1)*DMAX1(VJP12,0.D0))     
      EC2=AREA(KDR)*(ZX*HTCOEF(KDR)*(ALPBLK-ALP1J*THET1(1,KDR))+HTWEF*
     1ALPBLK)+ARC(KDR+1)*QCE 
      EC3=(ZLAMAB*TAO1(KDR)+ZLAMCR*SIG1(KDR))*AREA(KDR)
      EC4=TILCO2*(OMEG1(3,KDR)+OMEG1(4,KDR))+TILH2O*(OMEG1(1,KDR)+      
     1OMEG1(2,KDR))   
      ECJ=EC1+EC2+EC3-EC4
      FCJ=ARC(KDR)*DMAX1(VJM12,0.D0)*PHJM1
      GCJ=ARC(KDR+1)*DMAX1(-VJP12,0.D0)*PHJP1
      A(KDR)=ECJ      
      B(KDR)=GCJ      
      C(KDR)=FCJ      
      D(KDR)=-HCJ     
 5036 CONTINUE
C.....GIVEN MATRIX ELEMENTS, SOLVE FOR THE ENTHALPY INCREMENTS USING THE
C.....TDMA ALGORITHM. 
      P(1)=B(1)/A(1)  
      Q(1)=D(1)/A(1)  
      DO 5061 KPN=2,NUMNOD      
      P(KPN)=B(KPN)/(A(KPN)-C(KPN)*P(KPN-1))
      Q(KPN)=(D(KPN)+C(KPN)*Q(KPN-1))/(A(KPN)-C(KPN)*P(KPN-1))
 5061 CONTINUE
      DBLKEN(NUMNOD)=Q(NUMNOD)  
      DO 5062 KPN=1,NUMNOD-1    
      IARG=NUMNOD-KPN 
      DBLKEN(IARG)=P(IARG)*DBLKEN(IARG+1)+Q(IARG)   
 5062 CONTINUE
C.....CHECK TO MAKE SURE ENTHALPY CHANGE STAYS WITHIN BOUNDS.
      DO 6991 KN=1,NUMNOD
      IF(NACTIV(KN).EQ.0) GO TO 6991      
      IF(HTOT(KN).LE.0.D0) GO TO 6991      
      IF(ENBLK(KN)+DBLKEN(KN).GE.EDOWN(KN)) GO TO 6991 
      DBLKEN(KN)=EDOWN(KN)-ENBLK(KN)
 6991 CONTINUE
      RETURN
      END